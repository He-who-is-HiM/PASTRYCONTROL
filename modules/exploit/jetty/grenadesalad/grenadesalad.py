from recon.core.module import BaseModule

class Module(BaseModule):

    meta = {
    'name':'GRENADESALAD',
    'author':'gwaffles (https://twitter.com/gwaffles_)',
    'description':'Deobfuscates Jetty passwords.',
    'options':(
            ('string', None, True, 'obfuscated Jetty password.'),
        )
    }

    def module_run(self):
        string   = self.options['string']
        password = self.deobfuscate_jetty_string(string)

        if password:
            output = '%s => %s' % (string, password)
            self.output(output)

        elif not password:
            self.error('Not a \'jetty\' password.')

    def deobfuscate_jetty_string(self, string):
        try:
            # And the magic happends.
            password = ''
            b = bytearray(len(string) // 4)
            i = 0

            for x in b:
                t = string[i:i + 4]
                i0 = int(t, 36)
                i1 = i0 // 256
                i2 = i0 % 256
                x = (i1 + i2 - 254) // 2
                password += chr(x)
                i += 4
            return password
        except ValueError:
            return None
